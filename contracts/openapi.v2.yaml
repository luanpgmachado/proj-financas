openapi: 3.0.3

info:
  title: Financeiro B&L API
  version: v2
  description: |
    Contrato v2 do dominio financeiro do sistema.

    Esta versao adiciona os dominios de categorias e formas de pagamento,
    mantendo os endpoints de lancamentos e consolidacoes da v1.

servers:
  - url: "{api_base_url}"
    description: URL conceitual; configurar via variavel de ambiente no cliente.
    variables:
      api_base_url:
        default: http://localhost
        description: Base URL definida pelo cliente via ambiente.

tags:
  - name: financeiro
    description: Operacoes do dominio financeiro
  - name: categorias
    description: Operacoes de categorias
  - name: formas_pagamento
    description: Operacoes de formas de pagamento
  - name: autenticacao
    description: Autenticacao e controle de acesso

paths:
  /lancamentos:
    post:
      tags:
        - financeiro
      summary: Criar lancamento financeiro
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LancamentoFinanceiroCreate"
      responses:
        "201":
          description: Lancamento criado.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LancamentoFinanceiro"
        "422":
          description: Erro de validacao do payload.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErroValidacao"
        "404":
          description: Categoria ou forma de pagamento nao encontrada.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErroNaoEncontrado"
    get:
      tags:
        - financeiro
      summary: Listar lancamentos financeiros
      description: Retorna todos os lancamentos persistidos, sem filtros, paginacao ou ordenacao.
      responses:
        "200":
          description: Lista de lancamentos.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/LancamentoFinanceiro"
        "500":
          description: Erro ao acessar banco.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErroInterno"

  /consolidacoes/mensal:
    get:
      tags:
        - financeiro
      summary: Consolidacao mensal de lancamentos
      parameters:
        - name: competencia
          in: query
          required: true
          schema:
            $ref: "#/components/schemas/Competencia"
      responses:
        "200":
          description: Consolidacao mensal.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConsolidacaoMensal"
        "422":
          description: Erro de validacao do parametro.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErroValidacao"

  /categorias:
    post:
      tags:
        - categorias
      summary: Criar categoria
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CategoriaCreate"
      responses:
        "201":
          description: Categoria criada.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Categoria"
        "422":
          description: Erro de validacao do payload.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErroValidacao"
        "409":
          description: Conflito ao criar categoria.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErroConflito"
    get:
      tags:
        - categorias
      summary: Listar categorias
      description: Retorna todas as categorias persistidas, sem filtros, paginacao ou ordenacao.
      responses:
        "200":
          description: Lista de categorias.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Categoria"
        "500":
          description: Erro ao acessar banco.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErroInterno"

  /categorias/{categoria_id}:
    parameters:
      - name: categoria_id
        in: path
        required: true
        schema:
          $ref: "#/components/schemas/UUID"
    get:
      tags:
        - categorias
      summary: Obter categoria
      responses:
        "200":
          description: Categoria encontrada.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Categoria"
        "404":
          description: Categoria nao encontrada.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErroNaoEncontrado"
        "500":
          description: Erro ao acessar banco.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErroInterno"
    put:
      tags:
        - categorias
      summary: Atualizar categoria
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CategoriaUpdate"
      responses:
        "200":
          description: Categoria atualizada.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Categoria"
        "404":
          description: Categoria nao encontrada.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErroNaoEncontrado"
        "422":
          description: Erro de validacao do payload.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErroValidacao"
        "409":
          description: Conflito ao criar forma de pagamento.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErroConflito"
    delete:
      tags:
        - categorias
      summary: Remover categoria
      responses:
        "204":
          description: Categoria removida.
        "404":
          description: Categoria nao encontrada.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErroNaoEncontrado"

  /formas-pagamento:
    post:
      tags:
        - formas_pagamento
      summary: Criar forma de pagamento
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/FormaPagamentoCreate"
      responses:
        "201":
          description: Forma de pagamento criada.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FormaPagamento"
        "422":
          description: Erro de validacao do payload.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErroValidacao"
    get:
      tags:
        - formas_pagamento
      summary: Listar formas de pagamento
      description: Retorna todas as formas de pagamento persistidas, sem filtros, paginacao ou ordenacao.
      responses:
        "200":
          description: Lista de formas de pagamento.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/FormaPagamento"
        "500":
          description: Erro ao acessar banco.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErroInterno"

  /formas-pagamento/{forma_pagamento_id}:
    parameters:
      - name: forma_pagamento_id
        in: path
        required: true
        schema:
          $ref: "#/components/schemas/UUID"
    get:
      tags:
        - formas_pagamento
      summary: Obter forma de pagamento
      responses:
        "200":
          description: Forma de pagamento encontrada.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FormaPagamento"
        "404":
          description: Forma de pagamento nao encontrada.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErroNaoEncontrado"
        "500":
          description: Erro ao acessar banco.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErroInterno"
    put:
      tags:
        - formas_pagamento
      summary: Atualizar forma de pagamento
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/FormaPagamentoUpdate"
      responses:
        "200":
          description: Forma de pagamento atualizada.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FormaPagamento"
        "404":
          description: Forma de pagamento nao encontrada.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErroNaoEncontrado"
        "422":
          description: Erro de validacao do payload.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErroValidacao"
    delete:
      tags:
        - formas_pagamento
      summary: Remover forma de pagamento
      responses:
        "204":
          description: Forma de pagamento removida.
        "404":
          description: Forma de pagamento nao encontrada.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErroNaoEncontrado"

components:
  schemas:
    UUID:
      type: string
      format: uuid
      example: 3fa85f64-5717-4562-b3fc-2c963f66afa6

    Data:
      type: string
      format: date
      example: "2024-01-31"

    Competencia:
      type: string
      pattern: "^\\d{4}-(0[1-9]|1[0-2])$"
      example: "2024-01"

    Money:
      type: number
      format: double
      minimum: 0
      example: 1234.56

    Saldo:
      type: number
      format: double
      example: -123.45

    Usuario:
      type: object
      required:
        - id
        - nome
        - email
      properties:
        id:
          $ref: "#/components/schemas/UUID"
          readOnly: true
        nome:
          type: string
          minLength: 1
        email:
          type: string
          format: email

    Categoria:
      type: object
      description: Nome deve ser unico por usuario.
      required:
        - id
        - nome
        - usuario_id
      properties:
        id:
          $ref: "#/components/schemas/UUID"
          readOnly: true
        nome:
          type: string
          minLength: 1
        usuario_id:
          $ref: "#/components/schemas/UUID"
          readOnly: true

    CategoriaCreate:
      type: object
      required:
        - nome
      properties:
        nome:
          type: string
          minLength: 1

    CategoriaUpdate:
      type: object
      required:
        - nome
      properties:
        nome:
          type: string
          minLength: 1

    FormaPagamento:
      type: object
      description: Nome deve ser unico por usuario.
      required:
        - id
        - nome
        - usuario_id
      properties:
        id:
          $ref: "#/components/schemas/UUID"
          readOnly: true
        nome:
          type: string
          minLength: 1
        usuario_id:
          $ref: "#/components/schemas/UUID"
          readOnly: true

    FormaPagamentoCreate:
      type: object
      required:
        - nome
      properties:
        nome:
          type: string
          minLength: 1

    FormaPagamentoUpdate:
      type: object
      required:
        - nome
      properties:
        nome:
          type: string
          minLength: 1

    MetaFinanceira:
      type: object
      required:
        - id
        - nome
        - valor_planejado
        - competencia
        - usuario_id
      properties:
        id:
          $ref: "#/components/schemas/UUID"
          readOnly: true
        nome:
          type: string
          minLength: 1
        valor_planejado:
          $ref: "#/components/schemas/Money"
        competencia:
          $ref: "#/components/schemas/Competencia"
        usuario_id:
          $ref: "#/components/schemas/UUID"
          readOnly: true

    Investimento:
      type: object
      required:
        - id
        - tipo
        - valor
        - data
        - usuario_id
      properties:
        id:
          $ref: "#/components/schemas/UUID"
          readOnly: true
        tipo:
          type: string
          minLength: 1
          example: renda_fixa
        valor:
          $ref: "#/components/schemas/Money"
        data:
          $ref: "#/components/schemas/Data"
        usuario_id:
          $ref: "#/components/schemas/UUID"
          readOnly: true

    TipoLancamento:
      type: string
      enum:
        - ENTRADA
        - FIXO
        - VARIAVEL
        - PARCELADO

    LancamentoEntradaCreate:
      type: object
      required:
        - nome
        - data
        - competencia
        - tipo_lancamento
        - valor
      properties:
        nome:
          type: string
          minLength: 1
        data:
          $ref: "#/components/schemas/Data"
        competencia:
          $ref: "#/components/schemas/Competencia"
        tipo_lancamento:
          type: string
          enum:
            - ENTRADA
        valor:
          $ref: "#/components/schemas/Money"

    LancamentoFixoCreate:
      type: object
      required:
        - nome
        - data
        - competencia
        - tipo_lancamento
        - categoria_id
        - forma_pagamento_id
        - valor
        - pago
      properties:
        nome:
          type: string
          minLength: 1
        data:
          $ref: "#/components/schemas/Data"
        competencia:
          $ref: "#/components/schemas/Competencia"
        tipo_lancamento:
          type: string
          enum:
            - FIXO
        categoria_id:
          $ref: "#/components/schemas/UUID"
        forma_pagamento_id:
          $ref: "#/components/schemas/UUID"
        valor:
          $ref: "#/components/schemas/Money"
        pago:
          type: boolean

    LancamentoVariavelCreate:
      type: object
      required:
        - nome
        - data
        - competencia
        - tipo_lancamento
        - categoria_id
        - forma_pagamento_id
        - valor
        - pago
      properties:
        nome:
          type: string
          minLength: 1
        data:
          $ref: "#/components/schemas/Data"
        competencia:
          $ref: "#/components/schemas/Competencia"
        tipo_lancamento:
          type: string
          enum:
            - VARIAVEL
        categoria_id:
          $ref: "#/components/schemas/UUID"
        forma_pagamento_id:
          $ref: "#/components/schemas/UUID"
        valor:
          $ref: "#/components/schemas/Money"
        pago:
          type: boolean

    LancamentoParceladoCreate:
      type: object
      required:
        - nome
        - data
        - competencia
        - tipo_lancamento
        - categoria_id
        - forma_pagamento_id
        - valor_total
        - numero_parcelas
      properties:
        nome:
          type: string
          minLength: 1
        data:
          $ref: "#/components/schemas/Data"
        competencia:
          $ref: "#/components/schemas/Competencia"
        tipo_lancamento:
          type: string
          enum:
            - PARCELADO
        categoria_id:
          $ref: "#/components/schemas/UUID"
        forma_pagamento_id:
          $ref: "#/components/schemas/UUID"
        valor_total:
          $ref: "#/components/schemas/Money"
        numero_parcelas:
          type: integer
          minimum: 1

    LancamentoFinanceiroCreate:
      oneOf:
        - $ref: "#/components/schemas/LancamentoEntradaCreate"
        - $ref: "#/components/schemas/LancamentoFixoCreate"
        - $ref: "#/components/schemas/LancamentoVariavelCreate"
        - $ref: "#/components/schemas/LancamentoParceladoCreate"
      discriminator:
        propertyName: tipo_lancamento
        mapping:
          ENTRADA: "#/components/schemas/LancamentoEntradaCreate"
          FIXO: "#/components/schemas/LancamentoFixoCreate"
          VARIAVEL: "#/components/schemas/LancamentoVariavelCreate"
          PARCELADO: "#/components/schemas/LancamentoParceladoCreate"

    LancamentoBase:
      type: object
      required:
        - id
        - nome
        - data
        - competencia
        - tipo_lancamento
        - usuario_id
      properties:
        id:
          $ref: "#/components/schemas/UUID"
          readOnly: true
        nome:
          type: string
          minLength: 1
        data:
          $ref: "#/components/schemas/Data"
        competencia:
          $ref: "#/components/schemas/Competencia"
        tipo_lancamento:
          $ref: "#/components/schemas/TipoLancamento"
        usuario_id:
          $ref: "#/components/schemas/UUID"
          readOnly: true

    LancamentoGastoBase:
      description: |
        Lancamentos de gasto exigem categoria e forma de pagamento existentes.
        categoria_id referencia /categorias/{categoria_id}.
        forma_pagamento_id referencia /formas-pagamento/{forma_pagamento_id}.
      allOf:
        - $ref: "#/components/schemas/LancamentoBase"
        - type: object
          required:
            - categoria_id
            - forma_pagamento_id
          properties:
            categoria_id:
              $ref: "#/components/schemas/UUID"
            forma_pagamento_id:
              $ref: "#/components/schemas/UUID"

    LancamentoEntrada:
      description: Entrada financeira sem categoria ou forma de pagamento.
      allOf:
        - $ref: "#/components/schemas/LancamentoBase"
        - type: object
          required:
            - valor
          properties:
            valor:
              $ref: "#/components/schemas/Money"

    LancamentoFixo:
      allOf:
        - $ref: "#/components/schemas/LancamentoGastoBase"
        - type: object
          required:
            - valor
            - pago
          properties:
            valor:
              $ref: "#/components/schemas/Money"
            pago:
              type: boolean

    LancamentoVariavel:
      allOf:
        - $ref: "#/components/schemas/LancamentoGastoBase"
        - type: object
          required:
            - valor
            - pago
          properties:
            valor:
              $ref: "#/components/schemas/Money"
            pago:
              type: boolean

    LancamentoParcelado:
      description: Parcelado deriva parcelas mensais para calculo.
      allOf:
        - $ref: "#/components/schemas/LancamentoGastoBase"
        - type: object
          required:
            - valor_total
            - numero_parcelas
          properties:
            valor_total:
              $ref: "#/components/schemas/Money"
            numero_parcelas:
              type: integer
              minimum: 1

    LancamentoFinanceiro:
      oneOf:
        - $ref: "#/components/schemas/LancamentoEntrada"
        - $ref: "#/components/schemas/LancamentoFixo"
        - $ref: "#/components/schemas/LancamentoVariavel"
        - $ref: "#/components/schemas/LancamentoParcelado"
      discriminator:
        propertyName: tipo_lancamento
        mapping:
          ENTRADA: "#/components/schemas/LancamentoEntrada"
          FIXO: "#/components/schemas/LancamentoFixo"
          VARIAVEL: "#/components/schemas/LancamentoVariavel"
          PARCELADO: "#/components/schemas/LancamentoParcelado"

    ConsolidacaoMensal:
      type: object
      required:
        - competencia
        - total_entradas
        - total_gastos
        - total_investimentos
        - saldo
      properties:
        competencia:
          $ref: "#/components/schemas/Competencia"
        total_entradas:
          $ref: "#/components/schemas/Money"
        total_gastos:
          $ref: "#/components/schemas/Money"
        total_investimentos:
          $ref: "#/components/schemas/Money"
        saldo:
          $ref: "#/components/schemas/Saldo"

    PanoramaAnual:
      type: object
      required:
        - ano
        - resumos
      properties:
        ano:
          type: integer
          example: 2024
        resumos:
          type: array
          items:
            $ref: "#/components/schemas/ConsolidacaoMensal"

    ErroValidacaoItem:
      type: object
      required:
        - loc
        - msg
        - type
      properties:
        loc:
          type: array
          items:
            oneOf:
              - type: string
              - type: integer
        msg:
          type: string
        type:
          type: string
      additionalProperties: true

    ErroValidacao:
      type: object
      required:
        - detail
      properties:
        detail:
          type: array
          items:
            $ref: "#/components/schemas/ErroValidacaoItem"

    ErroConflito:
      type: object
      required:
        - detail
      properties:
        detail:
          type: string
          example: recurso ja existente

    ErroInterno:
      type: object
      required:
        - detail
      properties:
        detail:
          type: string
          example: erro ao acessar banco

    ErroNaoEncontrado:
      type: object
      required:
        - detail
      properties:
        detail:
          type: string
          example: recurso nao encontrado

  parameters: {}
  responses: {}
  securitySchemes: {}

security: []
