#!/usr/bin/env python3
import json
import os
import subprocess
import sys
import time
import urllib.request
from pathlib import Path


BASE_DIR = Path(__file__).resolve().parents[1]
DB_PATH = BASE_DIR / "data" / "financas_test.db"
BASE_URL = "http://127.0.0.1:8001"


def wait_for_server(timeout_seconds: float = 8.0) -> bool:
    deadline = time.time() + timeout_seconds
    while time.time() < deadline:
        try:
            with urllib.request.urlopen(f"{BASE_URL}/lancamentos", timeout=1) as resp:
                return resp.status == 200
        except Exception:
            time.sleep(0.2)
    return False


def http_post(path: str, payload: dict) -> tuple[int, dict]:
    data = json.dumps(payload).encode("utf-8")
    req = urllib.request.Request(f"{BASE_URL}{path}", data=data, method="POST")
    req.add_header("Content-Type", "application/json")
    with urllib.request.urlopen(req) as resp:
        return resp.status, json.load(resp)


def http_get(path: str) -> tuple[int, list]:
    with urllib.request.urlopen(f"{BASE_URL}{path}") as resp:
        return resp.status, json.load(resp)


def start_server() -> subprocess.Popen:
    env = os.environ.copy()
    env["FINANCAS_DB_PATH"] = str(DB_PATH)
    cmd = [sys.executable, "-m", "uvicorn", "app.main:app", "--port", "8001"]
    return subprocess.Popen(
        cmd,
        cwd=str(BASE_DIR),
        env=env,
        stdout=subprocess.PIPE,
        stderr=subprocess.STDOUT,
        text=True,
    )


def stop_server(proc: subprocess.Popen) -> None:
    if proc.poll() is None:
        proc.terminate()
        try:
            proc.wait(timeout=5)
        except subprocess.TimeoutExpired:
            proc.kill()


def main() -> int:
    if DB_PATH.exists():
        DB_PATH.unlink()

    proc = start_server()
    try:
        if not wait_for_server():
            print("Servidor nao iniciou.")
            return 1

        payload_entrada = {
            "nome": "Salario",
            "data": "2024-01-15",
            "competencia": "2024-01",
            "tipo_lancamento": "ENTRADA",
            "valor": 3500.00,
        }
        payload_fixo = {
            "nome": "Aluguel",
            "data": "2024-02-10",
            "competencia": "2024-02",
            "tipo_lancamento": "FIXO",
            "categoria_id": "11111111-1111-1111-1111-111111111111",
            "forma_pagamento_id": "22222222-2222-2222-2222-222222222222",
            "valor": 1200.00,
            "pago": True,
        }

        status, _ = http_post("/lancamentos", payload_entrada)
        if status != 201:
            print("POST entrada falhou.")
            return 1

        status, _ = http_post("/lancamentos", payload_fixo)
        if status != 201:
            print("POST fixo falhou.")
            return 1

    finally:
        stop_server(proc)

    proc = start_server()
    try:
        if not wait_for_server():
            print("Servidor nao iniciou na segunda execucao.")
            return 1

        status, body = http_get("/lancamentos")
        if status != 200:
            print("GET lancamentos falhou.")
            return 1

        if len(body) != 2:
            print("Quantidade inesperada de lancamentos:", len(body))
            return 1

        if body[0].get("data") != "2024-02-10":
            print("Ordenacao incorreta:", body[0].get("data"))
            return 1

        print("OK")
        return 0
    finally:
        stop_server(proc)


if __name__ == "__main__":
    raise SystemExit(main())
