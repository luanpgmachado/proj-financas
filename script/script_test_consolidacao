#!/usr/bin/env python3
import json
import os
import subprocess
import sys
import time
import urllib.request
from pathlib import Path


BASE_DIR = Path(__file__).resolve().parents[1]
DB_PATH = BASE_DIR / "data" / "financas_test_consolidacao.db"
BASE_URL = "http://127.0.0.1:8002"


def wait_for_server(timeout_seconds: float = 8.0) -> bool:
    deadline = time.time() + timeout_seconds
    while time.time() < deadline:
        try:
            with urllib.request.urlopen(f"{BASE_URL}/lancamentos", timeout=1) as resp:
                return resp.status == 200
        except Exception:
            time.sleep(0.2)
    return False


def http_post(path: str, payload: dict) -> tuple[int, dict]:
    data = json.dumps(payload).encode("utf-8")
    req = urllib.request.Request(f"{BASE_URL}{path}", data=data, method="POST")
    req.add_header("Content-Type", "application/json")
    with urllib.request.urlopen(req) as resp:
        return resp.status, json.load(resp)


def http_get(path: str) -> tuple[int, dict]:
    with urllib.request.urlopen(f"{BASE_URL}{path}") as resp:
        return resp.status, json.load(resp)


def start_server() -> subprocess.Popen:
    env = os.environ.copy()
    env["FINANCAS_DB_PATH"] = str(DB_PATH)
    cmd = [sys.executable, "-m", "uvicorn", "app.main:app", "--port", "8002"]
    return subprocess.Popen(
        cmd,
        cwd=str(BASE_DIR),
        env=env,
        stdout=subprocess.PIPE,
        stderr=subprocess.STDOUT,
        text=True,
    )


def stop_server(proc: subprocess.Popen) -> None:
    if proc.poll() is None:
        proc.terminate()
        try:
            proc.wait(timeout=5)
        except subprocess.TimeoutExpired:
            proc.kill()


def assert_close(actual: float, expected: float, label: str) -> bool:
    if abs(actual - expected) > 0.0001:
        print(f"{label} inesperado: {actual} (esperado {expected})")
        return False
    return True


def main() -> int:
    if DB_PATH.exists():
        DB_PATH.unlink()

    proc = start_server()
    try:
        if not wait_for_server():
            print("Servidor nao iniciou.")
            return 1

        payloads = [
            {
                "nome": "Salario",
                "data": "2024-01-05",
                "competencia": "2024-01",
                "tipo_lancamento": "ENTRADA",
                "valor": 1000.00,
            },
            {
                "nome": "Aluguel",
                "data": "2024-01-10",
                "competencia": "2024-01",
                "tipo_lancamento": "FIXO",
                "categoria_id": "11111111-1111-1111-1111-111111111111",
                "forma_pagamento_id": "22222222-2222-2222-2222-222222222222",
                "valor": 200.00,
                "pago": True,
            },
            {
                "nome": "Mercado",
                "data": "2024-01-12",
                "competencia": "2024-01",
                "tipo_lancamento": "VARIAVEL",
                "categoria_id": "33333333-3333-3333-3333-333333333333",
                "forma_pagamento_id": "44444444-4444-4444-4444-444444444444",
                "valor": 50.00,
                "pago": False,
            },
            {
                "nome": "Notebook",
                "data": "2024-01-15",
                "competencia": "2024-01",
                "tipo_lancamento": "PARCELADO",
                "categoria_id": "55555555-5555-5555-5555-555555555555",
                "forma_pagamento_id": "66666666-6666-6666-6666-666666666666",
                "valor_total": 300.00,
                "numero_parcelas": 3,
            },
        ]

        for payload in payloads:
            status, _ = http_post("/lancamentos", payload)
            if status != 201:
                print("POST lancamento falhou.")
                return 1

        status, body = http_get("/consolidacoes/mensal?competencia=2024-01")
        if status != 200:
            print("GET consolidacoes/mes falhou para 2024-01.")
            return 1

        ok = True
        ok &= assert_close(body.get("total_entradas", 0.0), 1000.00, "total_entradas")
        ok &= assert_close(body.get("total_gastos", 0.0), 350.00, "total_gastos")
        ok &= assert_close(body.get("total_investimentos", 0.0), 0.00, "total_investimentos")
        ok &= assert_close(body.get("saldo", 0.0), 650.00, "saldo")
        if not ok:
            return 1

        status, body = http_get("/consolidacoes/mensal?competencia=2024-02")
        if status != 200:
            print("GET consolidacoes/mes falhou para 2024-02.")
            return 1

        ok = True
        ok &= assert_close(body.get("total_entradas", 0.0), 0.00, "total_entradas")
        ok &= assert_close(body.get("total_gastos", 0.0), 100.00, "total_gastos")
        ok &= assert_close(body.get("total_investimentos", 0.0), 0.00, "total_investimentos")
        ok &= assert_close(body.get("saldo", 0.0), -100.00, "saldo")
        if not ok:
            return 1

        print("OK")
        return 0
    finally:
        stop_server(proc)


if __name__ == "__main__":
    raise SystemExit(main())
